#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –±–æ—Ç–∞ –Ω–∞ VPS

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Domastroi Bot..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python3."
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–æ—Ç–∞
BOT_DIR="/opt/domastroi-bot"
echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $BOT_DIR..."
sudo mkdir -p $BOT_DIR

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
echo "üìã –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã..."
sudo cp bot.py requirements.txt $BOT_DIR/
sudo cp .env $BOT_DIR/ 2>/dev/null || echo "‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é."

# –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "üêç –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
cd $BOT_DIR
sudo python3 -m venv venv
sudo $BOT_DIR/venv/bin/pip install --upgrade pip
sudo $BOT_DIR/venv/bin/pip install -r requirements.txt

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º systemd service
echo "‚öôÔ∏è  –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º systemd service..."
sudo cp domastroi-bot.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable domastroi-bot.service

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
sudo systemctl start domastroi-bot.service

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
sleep 2
if sudo systemctl is-active --quiet domastroi-bot.service; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    echo "üìä –°—Ç–∞—Ç—É—Å: sudo systemctl status domastroi-bot"
    echo "üìù –õ–æ–≥–∏: sudo journalctl -u domastroi-bot -f"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: sudo journalctl -u domastroi-bot -n 50"
    exit 1
fi

